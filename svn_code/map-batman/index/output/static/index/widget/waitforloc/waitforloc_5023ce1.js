define("index:widget/waitforloc/waitforloc.js",function(e,t,n){var i=e("common:widget/geolocation/geolocation.js"),a=e("common:widget/broadcaster/broadcaster.js"),r=e("common:widget/url/url.js"),o=e("common:widget/geolocation/location.js");n.exports={config:{lineQtMap:{bt:"bse"},qtMap:{place:"s|con|nb|bd",transit:"bt|bse",drive:"nav|nse",walk:"walk|wse"}},init:function(){this.initIpGeo(),this.bindEvent(),this.initGeo()},initIpGeo:function(){try{var e=window.localStorage;window._DEFAULT_CITY.index?(e.setItem("_DEFAULT_CITY",JSON.stringify(window._DEFAULT_CITY)),cookie.set("DEFAULT_CITY","1",{expires:3e5,domain:"baidu.com",path:"/"})):window._DEFAULT_CITY=JSON.parse(e.getItem("_DEFAULT_CITY"))||{}}catch(t){}var n,i,a,r,s;n=JSON.parse(_DEFAULT_CITY.index)||{},i=n&&n.content,a=i&&i.geo,s=i.level,r=a.split(";")[1].split("|")[0].split(","),1==i.code&&(i.name="全国"),locationData={addr:{city:i.cname,cityCode:i.code},point:{x:r[0],y:r[1]},level:s,type:"ip",isExactPoi:!1,isGeoEnd:!1},o.setAddress(locationData)},bindEvent:function(){var e=this;a.subscribe("geolocation.success",function(){e.geoSuccess()}),a.subscribe("geolocation.fail",function(){e.geoFail()})},initGeo:function(){var e=this;i.init(),setTimeout(function(){e.geoFail()},8e3)},geoSuccess:function(){var e=r.get();this._initMixLocOptionsPage(e)},geoFail:function(){var e=r.get();this.locErrorCallback(e)},_initMixLocOptionsPage:function(e){var t=this,n=e.pageState&&e.pageState.needloc;e.query,n&&"1"===n?t._initPlacePage(e):t._initTransitPage(e)},_initTransitPage:function(e){var t="我的位置",n=e.query||{},i=n.sn||"",a=n.en||"";geoQuery=n,key="sn",snArr=""+i.split("$$")[3],enArr=""+a.split("$$")[3],q="1$$$$"+o.getPointX()+","+o.getPointY()+"$$我的位置$$",wd=geoQuery.wd?geoQuery.wd:snArr!=t?snArr:enArr,snArr===t||enArr===t?enArr===t&&(key="en"):key=""===$.trim(snArr)?"sn":"en",geoQuery[key]=q,geoQuery=$.extend(geoQuery,{ptx:o.getPointX(),pty:o.getPointY(),bsetp:1,ec:o.getCityCode(),sc:o.getCityCode(),isSingle:"true",name:t,wd:wd}),geoQuery.qt=this.config.lineQtMap[geoQuery.qt]||geoQuery.qt,r.update({module:"search",action:"search",query:geoQuery,pageState:{has_handle_geo:1,needloc:""}},{trigger:!0,replace:!0})},getSearchTypeConfig:function(){var e=this.config.qtMap,t={};return $.each(e,function(e,n){_qt=n.split("|"),$.each(_qt,function(n,i){t[i]=e})}),t},_initPlacePage:function(e){var t=this,n={center_rank:1,nb_x:o.getPointX(),nb_y:o.getPointY(),c:o.getCityCode()};t._getOptions(e,n),r.update({module:"search",action:"search",query:{center_rank:n.center_rank,nb_x:n.nb_x,nb_y:n.nb_y,c:n.c},pageState:{center_name:"我的位置",has_handle_geo:1,needloc:""}},{replace:!0})},_getOptions:function(e,t){for(var n in t)e.query[n]=t[n];return e},_initPage:function(){this._searchData()},locErrorCallback:function(e){var t=this.getSearchType(e);switch(t){case"place":this._initPage(e);break;case"walk":case"transit":case"drive":this.setSearchBoxValue(e);default:this._switchToIndex(e)}},getSearchType:function(e){if(e){var t=e.query||{},n=t.qt,i=this.searchTypeConfig||this.getSearchTypeConfig();return this.searchTypeConfig=i,i[n]}},setSearchBoxValue:function(e){var t=this._getStartAndEndWord(e)||{},n="我的位置";t.start&&t.start!=n&&(this.start="word="+encodeURIComponent(t.start)),t.end&&t.end!=n&&(this.end="word="+encodeURIComponent(t.end))},_getUrl:function(){var e=r.get().query||{};return this.isLanding&&(third_party=location.href.match(/[\?\&]third_party=([^&^#]+)/),third_party&&(e.searchFlag=third_party[1]||"","baidukuangpush"===third_party[1]&&(e.tg="push"))),e.c||(e.c=o.getCityCode()),["nav","nse","walk","wse"].indexOf(e.qt)>=0&&(e.version="3"),("nav"==e.qt||"bt"==e.qt)&&(e.wd1&&!e.sn&&(e.sn="2$$$$$$"+e.wd1+"$$"),e.wd2&&!e.en&&(e.en="2$$$$$$"+e.wd2+"$$")),e},_searchData:function(){var e=this._getUrl();r.update({module:"search",action:"search",query:e,pageState:{needloc:""}},{replace:!0,queryReplace:!0})},_switchToIndex:function(e){var t=this.getSearchType(e),n=e.pagestate||{},i=e.query||{},a="";n.tab=t,("walk"===n.tab||"drive"===n.tab||"transit"===n.tab)&&(a="line");var o={};this.start&&(o.start=this.start),this.end&&(o.end=this.end),o.tab=a,r.update({module:"index",action:"index",query:i,pageState:o},{trigger:!0,replace:!0,queryReplace:!0,pageStateReplace:!0})},_getStartAndEndWord:function(e){if(e&&e.query){var t=e.query,n=t.sn||"",i=t.en||"",a=n.split("$$")[3]||t.name||"",r=i.split("$$")[3]||t.wd||"";return{start:a,end:r}}}}});