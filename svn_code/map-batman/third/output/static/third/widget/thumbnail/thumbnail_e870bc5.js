define("third:widget/thumbnail/thumbnail.js",function(t,i,e){var s=t("common:widget/broadcaster/broadcaster.js"),n=t("common:static/js/util.js"),o=(t("common:widget/url/url.js"),t("common:widget/popup/popup.js")),a=t("common:widget/geolocation/location.js");stat=t("common:widget/stat/stat.js");var r={type:0,level:16,height:101,width:window.innerWidth-22,url:null,host:"http://snap.map.baidu.com/?qt=snap&data="};e.exports={flag:{appreszie:!1,wait:void 0},state:"start",init:function(){this.prevPoint=void 0,this.render(),this.bind()},render:function(){this.thumbImg=$(".thumb-img"),this.thumbWrap=$(".thumb-wrap"),this.locbarTxt=$(".locbar-txt"),this.centerMarker=$(".center-marker"),this.geoBtn=$(".geo-btn"),this.inBtn=$(".in-btn"),this.errorCnt=$(".error-cnt"),this.thumbLink=$(".thumb-link"),this.setState("start"),this.setUserHeading()},bind:function(){var t=this;t.geoBtn.on("click",function(i){stat.addStat(STAT_CODE.STAT_THUNB_START_GEO),t.startGeo(),i.stopImmediatePropagation(),i.stopPropagation()}),t.thumbImg.on("load",function(){t.errorCnt.hide(),t.thumbImg.show(),t.geoBtn.show(),t.hideLoading()}),t.thumbImg.on("error",function(){t.errorCnt.show(),t.thumbImg.hide(),t.centerMarker.hide(),t.hideLoading()}),s.subscribe("geolocation.success",function(){this.successCBK()},this),s.subscribe("geolocation.fail",function(){this.failCBK()},this)},successCBK:function(){this.flag.appreszie||(s.subscribe("sizechange",function(){this._appReSize()},this),this.flag.appreszie=!0),this.setState("success")},failCBK:function(){this.setState("fail")},setState:function(t){switch(this.flag.state=t,this.addStateToLog(t),t){case"start":this.state="start",this.showLoading(),this.waitForLoc(8);break;case"success":this.state="success",this.hideLoading(),this.setLocation();break;case"fail":this.state="fail",this.hideLoading(),this.centerMarker.hide(),o.open({text:"定位失败"}),this.setLocation(),this.flag.wait&&window.clearTimeout(this.flag.wait)}},addStateToLog:function(t){if("success"===t||"fail"===t){var i={code:STAT_CODE.STAT_THUMB_IMG_CLICK,state:t};this.thumbLink.data("log",JSON.stringify(i))}},startGeo:function(){this.setState("start"),a.startGeo()},waitForLoc:function(t){var i=this;i.flag.wait&&window.clearTimeout(i.flag.wait),i.flag.wait=window.setTimeout(function(){"success"!=i.state&&i.failCBK()},1e3*t)},setUserHeading:function(){var i=t("third:widget/thumbnail/userheading.js");if(i.isSupport()){this.centerMarker.addClass("navi-marker");var e=$(".center-marker div").get(0);i.start(e)}},setLocation:function(){var t=a.getCenterPoi();this._unEqualPoint(t)?(this.prevPoint=t,this._setThumbUrl()):void 0!=this.prevPoint&&this.hideLoading(),this._setLocBarAddress(),this._setGeoBtnStatus(),this._setSearchBoxCity()},showLoading:function(){n.showLoading(this.thumbWrap),this.locbarTxt.html("正在定位您的位置...")},hideLoading:function(){n.hideLoading(this.thumbWrap)},_setLocBarAddress:function(t){var i=t||a.getAddress();this.locbarTxt.html(i)},_setSearchBoxCity:function(t){var t=t||a.getCity();$(".se-city-wd").html(t)},_setGeoBtnStatus:function(){a.hasExactPoi()?this.geoBtn.removeClass("geo-fail"):this.geoBtn.addClass("geo-fail")},_setThumbUrl:function(t){var i=this,e=t||i._getThumbUrl();a.hasExactPoi()?i.centerMarker.show():i.centerMarker.hide(),i.thumbImg.attr("src",e)},_appReSize:function(){var t=this;n.isAndroid()?setTimeout(function(){r.width=window.innerWidth-22},800):r.width=window.innerWidth-22,t._setThumbUrl()},_equalPoint:function(t){return this.prevPoint&&this.prevPoint.x==t.x&&this.prevPoint.y==t.y},_unEqualPoint:function(t){return void 0==this.prevPoint||t.x!=this.prevPoint.x||t.y!=this.prevPoint.y},_getThumbUrl:function(t){r.level=0==r.type?"全国"==a.getCity()?3:a.hasExactPoi()?16:10:10,void 0==t&&(t=a.getCenterPoi());var i={retype:1,src:"webapp",level:r.level,center:t.x+" "+t.y,height:101,width:r.width,coordtype:"M",pictype:r.type};return r.host+JSON.stringify(i)}}});