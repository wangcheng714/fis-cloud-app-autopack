define("place:widget/order/order.js",function(e,t,o){"use strict";var i=e("common:widget/popup/popup.js"),a=e("place:static/js/vcode.js"),r=e("common:static/js/util.js"),n=$("#hotelOrder"),s=$("#priceTotal");o.exports={ERRORMSG:{PHONEEMPTY:"请填写手机号码",PHONEERROR:"您输入的手机号码有误，请重新输入",NAMEERROR:"请输入正确姓名确保顺利入住",TIMEERROR:"抱歉！预定日期范围错误，请点击屏幕重新选择！",PRICEERROR:"抱歉！您预订的酒店价格发生变化，请点击屏幕确认重新确认。",FORMORDER:"抱歉！填写内容有误，请点击屏幕返回检查填写内容！",VALIDATEERROR:"验证码填写错误，请点击屏幕重新填写！",ROOMERROR:"抱歉！您预订的房间数超过剩余房量，请点击屏幕确认重新选择。",DEFAULT:"抱歉！发生未知错误，请点击屏幕返回重试！"},init:function(e){var t=this;e&&t.renderRoom(e),t.bind(),t.vcode=new a({el:$(".verifycode-img")}),this.room_info=e},bind:function(){var e=this;n.find("select").on("change",function(t){e.changeSelect(t)}),$("#submitButton").on("click",$.proxy(e.submitData,e))},maxRoom:function(e){if(e){var t=3;return $.each(e,function(o){e[o].room_left<t&&(t=e[o].room_left)}),t}},roomPrice:function(e){if(e){var t,o=0;return $.each(e,function(i){t=parseInt(e[i].price,10),o+=t}),o}},renderRoom:function(e){for(var t=this,o=t.maxRoom(e),i=t.roomPrice(e),a=1;o>=a;a++){var r=[];r.push('<option value="'+a+'">'+a+"间</option>"),n.find("select").append(r.join(""))}s.attr("single",i).html(i)},changeSelect:function(e){var t=e.target,o=$(t),i=$(o[0][o[0].selectedIndex]),a=i.val(),r=s.attr("single");$(t).parent().children("em").html(i.text()),s.html(r*a),n.find("input[name=room_num]").val(a),this.guestItemOperator(a)},guestItemOperator:function(e){var t=$("#moreGuest input"),o=t.length;if(e>o)for(var i=1;e-o>i;i++){var a=[];a.push('<div class="guest-item guest-name"><em class="icon guest-icon"></em><input type="text" maxlength="20" class="guest" index='+(o+i)+' name="guests" value="" placeholder="姓名,每间填1人" /></div>'),$("#moreGuest").append(a.join(""))}else $.each(t,function(){var t=$(this).attr("index");t>e-1&&$(this).parent().remove()})},getPrices:function(e){var t=[];if(e)return $.each(e,function(){t.push({price:this.price,date:this.date})}),JSON.stringify(t)},getAllData:function(e){var t=this,o={},i=[];return n.find("input").each(function(){o[$(this).prop("name")]=$(this).val()}),o.prices=s.attr("room_price")?s.attr("room_price"):t.getPrices(e),$.each($('input[name="guests"]'),function(){i.push(encodeURI($(this).val()))}),o.guests=i.join(","),o},validateData:function(e){var t=e.phone,o=e.guests.split(","),a=e.code,r=/^[\u4E00-\u9FA5]+$/,n=/^[A-Za-z]+$/,s=!0;if($.each(o,function(e){var e=decodeURI(this);return r.test(e)||n.test(e)||(s=!1),s}),""===t)i.open({text:this.ERRORMSG.PHONEEMPTY,autoCloseTime:1500});else if(-1==t.search(/^((1(5[0-9]|8[0-9]|3[0-9]|47))+\d{8})$/))i.open({text:this.ERRORMSG.PHONEERROR,autoCloseTime:1500});else if(s){if(""!==a&&4==a.length)return!0;i.open({text:this.ERRORMSG.VALIDATEERROR,autoCloseTime:1500})}else i.open({text:this.ERRORMSG.NAMEERROR,autoCloseTime:1500})},submitData:function(){var e=this,t=e.getAllData(this.room_info);e.validateData(t)&&e.handleOrderSubmit(t)},addLayer:function(){if(0==$("#bmap_pop_cover").length){var e=document.createElement("div");e.id="bmap_pop_cover",$.extend(e.style,{background:"rgba(0, 0, 0, 0.2)",height:"100%",width:"100%",top:"0px",left:"0px",zIndex:"80000",position:"absolute",overflow:"hidden",display:"block"}),$("#wrapper").append(e)}else $("#bmap_pop_cover").css("display","block")},handleOrderSubmit:function(e){var t=this,o=s.attr("single"),a=r.urlToJSON(window.location.search.split("?")[1]),n=a.kehuduan?"webview":"maponline",c="/detail?qt=order&from="+n;$.ajax({type:"POST",url:c,dataType:"json",data:e,success:function(e){switch(e.errorNo){case 0:window.location.href="/mobile/webapp/place/order/qt=thirdsrc_order_success&order_id="+e.order_id;break;case 10004:t.addLayer(),i.open({text:t.ERRORMSG.TIMEERROR,autoCloseTime:!1,isTouchHide:!0});break;case 10006:case 10007:case 10008:t.addLayer(),i.open({text:t.ERRORMSG.FORMORDER,autoCloseTime:!1,isTouchHide:!0});break;case 10010:t.addLayer(),i.open({text:t.ERRORMSG.VALIDATEERROR,autoCloseTime:!1,isTouchHide:!0});break;case 30002:t.addLayer(),i.open({text:t.ERRORMSG.ROOMERROR,autoCloseTime:!1,isTouchHide:!0}),t.HandelRoomChange(o,e.room_num);break;case 30005:t.addLayer(),i.open({text:t.ERRORMSG.PRICEERROR,autoCloseTime:!1,isTouchHide:!0}),t.HandelPriceChange(e.prices);break;default:var a=e.errorNo.toString().substr(0,1),r=e.errorMsg;switch(a){case"1":case"3":case"4":t.addLayer(),i.open({text:t.ERRORMSG.DEFAULT,autoCloseTime:!1,isTouchHide:!0});break;case"2":case"5":default:window.location.href="/mobile/webapp/place/order/qt=hotel_error&msg="+r}}t.vcode.refreshVcode()},error:function(){$(".common-widget-popup").hide(),t.addLayer(),i.open({text:t.ERRORMSG.DEFAULT,autoCloseTime:!1,isTouchHide:!0}),t.vcode.refreshVcode()}})},HandelRoomChange:function(e,t){var o,i=n.find(".number");i.html(t+"间"),n.find("input[name=room_num]").val(t);var a=$("select option");$.each(a,function(){o=$(this).val(),o>t&&$(this).remove()}),$(a[t-1]).attr("selected","selected");var r=$("#moreGuest input");$.each(r,function(){o=$(this).attr("index"),o>t-1&&$(this).parent().remove()}),s.html(e*t)},HandelPriceChange:function(e){var t=this.getPrices(e),o=this.roomPrice(e),i=n.find("input[name=room_num]").val();s.html(o*i),s.attr("single",o),s.attr("room_price",t)}}});