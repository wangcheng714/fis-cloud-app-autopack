define("place:widget/hotelbook/hotelbook.js",function(t,o,i){"use strict";var s=t("common:widget/broadcaster/broadcaster.js"),a=t("place:static/js/broadcastname.js"),e=t("common:static/js/util.js"),h=t("common:widget/geolocation/location.js"),n=t("common:widget/popup/popup.js"),l=t("common:widget/stat/stat.js");i.exports={create:function(){var t=this.$el=$(".place-widget-hotel-book");this.serverAddr="http://"+location.host+"/mobile/webapp/place/hotelbook/async=1&qt=",this.$showAllRoom=t.find(".show-all-room"),this.$showAllOta=t.find(".show-all-ota"),this.$hbMain=t.find(".main"),this.$roomsWp=t.find(".rooms"),this.$rooms=t.find(".room-list > li"),this.$roomsHide=t.find(".room-list > li").slice(3),this.$otasHide=t.find(".ota-list > li").slice(3),this.$otaResult=t.find(".ota-result"),this.$fetchFailed=t.find(".ota-failed"),this.$bookBtn=t.find(".ota-bookbtn"),this.uid=$("#uid").html(),this.isShowAllRoom=!1,this.isShowAllOta=!1,this.isShowOta=!0,this.lastIndex="0",this.currentIndex="0",s.subscribe(a.DATEPICKER_DATE_CHANGE,$.proxy(this.onDatepickerDateChange,this)),s.broadcast(a.HOTELBOOK_OR_THIRDSRCOTA_SHOW)},onDatepickerDateChange:function(t){if(t.sd!==this.sd||t.ed!==this.ed){this.sd=t.sd,this.ed=t.ed;var o={st:t.sd,et:t.ed,uid:this.uid};BigPipe.asyncLoad({id:"place-pagelet-hotelbook"},e.jsonToUrl(o))}},bindEvents:function(){this.bindRoomListEvents()},bindRoomListEvents:function(){this.$showAllRoom.on("click",$.proxy(this.showAllRoom,this)),this.$showAllOta.on("click",$.proxy(this.showAllOta,this)),this.$rooms.on("click",$.proxy(this.fetchOtas,this)),this.$bookBtn.on("click",$.proxy(this.goToBook,this))},unbindEvents:function(){this.unbindRoomListEvents()},unbindRoomListEvents:function(){this.$showAllRoom.off("click",$.proxy(this.showAllRoom,this)),this.$showAllOta.off("click",$.proxy(this.showAllOta,this)),this.$rooms.off("click",$.proxy(this.fetchOtas,this)),this.$bookBtn.off("click",$.proxy(this.goToBook,this))},showAllRoom:function(t){this.isShowAllRoom?(this.lastIndex>2&&(this.$otaResult=this.$el.find(".ota-result"),this.$otaResult.remove(),this.$el.find(".arrow-icon-open").attr("class","arrow-icon"),this.isShowOta=!1,this.isShowAllOta=!1),this.$showAllRoom.find("span").eq(0).html("查看其他房型"),this.isShowAllRoom=!1):(this.$showAllRoom.find("span").eq(0).html("收起其他房型"),this.isShowAllRoom=!0),this.$roomsHide.toggle(),this.$showAllRoom.toggleClass("show-all-room-open"),t.stopPropagation(),t.stopImmediatePropagation()},showAllOta:function(t){this.isShowAllOta?(this.$showAllOta.find("span").eq(0).html("展开其他报价"),this.isShowAllOta=!1):(this.$showAllOta.find("span").eq(0).html("收起其他报价"),this.isShowAllOta=!0),this.$otasHide.toggle(),this.$showAllOta.toggleClass("show-all-ota-open"),t.stopPropagation(),t.stopImmediatePropagation()},fetchOtas:function(t){var o,i,s=this.$el,a=_APP_HASH.action,e=$(t.target).closest("li").find("span").eq(1).text(),h={};"detail"===a?l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_ROOM_CLICK,{name:this.poiname,type:e}):"hotelbook"===a&&l.addStat(STAT_CODE.PLACE_HOTEL_BOOK_ROOM_CLICK,{name:this.poiname,type:e}),this.$targetRoom=$(t.target).closest("li"),this.currentIndex=this.$targetRoom.attr("index"),this.isShowOta&&this.currentIndex==this.lastIndex?(this.$otaResult=s.find(".ota-result"),this.$otaResult.remove(),this.$targetRoom.find("span").eq(0).attr("class","arrow-icon"),this.isShowOta=!1):(this.unbindEvents(),this.$otaResult=s.find(".ota-result"),this.$otaResult.remove(),this.$fetchFailed=s.find(".ota-failed"),this.$fetchFailed.remove(),this.$targetRoom.find("span").eq(0).attr("class","arrow-icon-open"),i='<div class="ota-fetching"><span></span><span>正在获取实时精准报价数据...</span></div>',this.$targetRoom.after(i),o=this.$targetRoom.attr("ota_price_url"),h={type:"POST",url:this.serverAddr+"fetchotas",data:{uid:this.uid,otaPriceUrl:o},dataType:"html"},this.fetchData(h,$.proxy(this.doFetchOtaSuccess,this),$.proxy(this.doFetchOtaError,this)),this.isShowOta=!0,this.lastIndex=this.$targetRoom.attr("index")),this.$bookBtn.off("click",this.goToBook),t.stopPropagation(),t.stopImmediatePropagation()},fetchData:function(t,o,i){$.ajax({type:t.type,url:t.url,data:t.data,dataType:t.dataType,success:function(t){o(t)},error:function(t,o){i(t,o)}})},doFetchOtaSuccess:function(t){this.$targetRoom.next().remove(),this.$showAllOta.off("click",$.proxy(this.showAllOta,this)),this.$el.find(".arrow-icon-open").attr("class","arrow-icon"),this.$targetRoom.after(t),this.$targetRoom.find("span").eq(0).attr("class","arrow-icon-open"),this.$showAllOta=this.$el.find(".show-all-ota"),this.$otasHide=this.$el.find(".ota-list > li").slice(3),this.$bookBtn=this.$el.find(".ota-bookbtn"),this.bindEvents()},doFetchOtaError:function(){this.bindEvents()},doFetchRoomSuccess:function(t){var o=this.$el;this.unbindRoomListEvents(),this.$hbMain.append(t),this.$showAllRoom=o.find(".show-all-room"),this.$showAllOta=o.find(".show-all-ota"),this.$rooms=o.find(".room-list > li"),this.$roomsHide=o.find(".room-list > li").slice(3),this.$otasHide=o.find(".ota-list > li").slice(3),this.$roomsWp=o.find(".rooms"),this.$bookBtn=o.find(".ota-bookbtn"),this.$bookBtn.on("click",goToBook),this.bindEvents(),this.isShowAllRoom=!1,this.isShowOta=!0,this.isShowAllOta=!1},doFetchRoomError:function(){this.bindEvents()},goToBook:function(t){var o,i,s=$(t.target),a=_APP_HASH.action,d=s.data("url"),r=s.closest("li").find("span").eq(1).text(),c=s.parent().find(".ota-name").text(),m=(new Date).format("yyyy-MM-dd"),p=new Date((new Date).getTime()+864e5).format("yyyy-MM-dd"),f=parseInt(s.data("price"),10),O=parseInt(s.data("bonus"),10)||0;s.hasClass("ota-bookbtn-web")?("detail"===a?(o=$(".place-widget-captain .name").text(),l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_BOOKBTN_PC_CLICK,{name:this.poiname,type:r,ota:c})):"hotelbook"===a&&l.addStat(STAT_CODE.PLACE_HOTEL_BOOK_BOOKBTN_PC_CLICK,{name:this.poiname,type:r,ota:c}),n.open({text:"您好，此酒店报价需要在电脑端登陆：map.baidu.com，在酒店版块中进行搜索预订",autoCloseTime:3e3})):s.hasClass("ota-bookbtn-tel")?("detail"===a?l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_BOOKBTN_TEL_CLICK,{name:this.poiname,type:r,ota:c}):"hotelbook"===a&&l.addStat(STAT_CODE.PLACE_HOTEL_BOOK_BOOKBTN_TEL_CLICK,{name:this.poiname,type:r,ota:c}),e.isAndroid()&&(s.attr("href","javascript:void(0)"),e.TelBox.showTb(s.attr("phone")))):(i={from_page:a,checkin_date:this.sd||m,checkout_date:this.ed||p,c:h.getCityCode(),price:f,book_price:f-O,simple:1},window.open(d+"&"+e.jsonToQuery(i),"_blank")),t.stopPropagation(),t.stopImmediatePropagation()},refreshPage:function(){this.$roomsWp.remove(),this.isShowOta=!0,this.isShowAllRoom=!1,this.isShowAllOta=!1;var t={type:"POST",url:this.serverAddr+"fetchrooms",data:{uid:this.uid,st:this.sd,et:this.ed},dataType:"html"};this.fetchData(t,$.proxy(this.doFetchRoomSuccess,this),$.proxy(this.doFetchRoomError,this))},init:function(){var t=_APP_HASH.action;this.create(),"detail"===t?this.poiname=$(".place-widget-captain .name").text():"hotelbook"===t&&(this.poiname=$(".place-widget-hotel-info p").eq(0).text()),"detail"===t&&l.addStat(STAT_CODE.PLACE_HOTEL_BOOKABLE_DETAIL_VIEW,{name:this.poiname}),this.bindEvents()}}});